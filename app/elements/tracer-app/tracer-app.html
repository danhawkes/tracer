<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../../bower_components/core-scaffold/core-scaffold.html">
<link rel="import" href="../../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../../bower_components/core-transition/core-transition.html">
<link rel="import" href="../../bower_components/core-icons/core-icons.html">
<link rel="import" href="../../bower_components/core-icon/core-icon.html">
<link rel="import" href="../../bower_components/core-icons/maps-icons.html">
<link rel="import" href="../../bower_components/core-icons/av-icons.html">
<link rel="import" href="../../bower_components/core-menu/core-menu.html">
<link rel="import" href="../../bower_components/core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="../../bower_components/core-item/core-item.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-action-dialog.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">


<polymer-element name="tracer-app" layout>

  <template>
    <link rel="stylesheet" href="tracer-app.css" shim-shadowdom>

    <tracer-location id="location" enabled="{{state === RECORDING}}"
                     on-slowlock="{{showWaitingForLocationToast}}"
                     on-position="{{onNewLocation}}"></tracer-location>

    <core-drawer-panel id="drawerPanel" narrow="{{narrow}}">

      <core-header-panel drawer mode="seamed">
        <core-toolbar id="drawerToolbar"></core-toolbar>
        <core-menu id="menu" selectedAttribute="" selected="0" on-core-select="{{onMenuItemSelected}}">
          <template repeat="{{menuItems}}">
            <tracer-menuitem icon="{{icon}}" label="{{name}}"></tracer-menuitem>
          </template>
        </core-menu>
        <tracer-menuitem icon="polymer" label="My Traces"
                         on-click="{{showTracesDialog}}"></tracer-menuitem>
        <tracer-menuitem icon="cloud-download" label="Install" on-click="{{installApp}}"
                         hidden?="{{!installable}}"></tracer-menuitem>
        <tracer-menuitem icon="info" label="About" on-click="{{showAboutDialog}}"></tracer-menuitem>
      </core-header-panel>

      <core-header-panel main>

        <core-toolbar id="mainToolbar">
          <paper-icon-button icon="menu" hidden?="{{!narrow}}" on-click="{{toggleDrawer}}"></paper-icon-button>
          <div>Tracer</div>
        </core-toolbar>

        <tracer-map id="map" fit></tracer-map>

        <div id="action-buttons" layout vertical>
          <paper-fab id="fab-startstop" icon="maps:my-location" on-click="{{showLocation}}"></paper-fab>
          <paper-fab id="fab-locate" icon="{{recording ? 'av:stop' : 'av:play-arrow'}}"
                     on-click="{{toggleRecording}}"></paper-fab>
        </div>

        <paper-action-dialog id="aboutDialog" heading="About" transition="core-transition-center">
          <p>
            Built with
            <a href="https://www.polymer-project.org">Polymer</a>,
            <a href="http://leafletjs.com/">Leaflet.js</a> and
            <a href="https://www.mapbox.com">Mapbox</a>.
          </p>

          <p>
            Contribute on <a href="https://github.com/danhawkes/tracer">Github</a>.
          </p>
          <paper-button affirmative>OK</paper-button>
        </paper-action-dialog>

        <tracer-tracesdialog id="tracesDialog" db="{{db}}" on-trace-select="{{showTrace}}"></tracer-tracesdialog>

        <paper-toast id="waitingForLocationToast" text="Waiting for locationâ€¦"></paper-toast>
        <paper-toast id="cantShowTraceToast" text="Can't show this trace while recording!"></paper-toast>


      </core-header-panel>
    </core-drawer-panel>

  </template>

  <script>
    (function() {

      var IDLE = 'idle';
      var RECORDING = 'recording';
      var SHOWING_TRACE = 'showingTrace';

      Polymer({
        computed: {
          idle: 'state === "idle"',
          recording: 'state === "recording"',
          showingTrace: 'state == "showingTrace"'
        },
        created: function() {
          this.menuItems = [
            {name: 'Map', icon: 'maps:map'}
          ];
          this.manifestUrl = location.href + 'manifest.webapp';
          this.manifestPackageUrl = location.href + 'packaged/mini-manifest.webapp';
          this.installable = false;
          this.db = document.createElement('tracer-db');
          this.trace = null;
          this.state = IDLE;

          // UI hacks
          this.menuLastSelected = 0;

          this.updateInstallButtonVisibility();
        },

        onMenuItemSelected: function(e, detail) {
          if (detail.isSelected) {
            var id = detail.item.id;
          }
          this.$.drawerPanel.closeDrawer();
        },

        showAboutDialog: function() {
          this.$.drawerPanel.closeDrawer();
          this.$.aboutDialog.opened = true;
        },

        showTracesDialog: function() {
          this.$.drawerPanel.closeDrawer();
          this.$.tracesDialog.opened = true;
        },

        showTrace: function(e) {
          var traceId = e.detail;
          this.db.loadTrace(traceId).then(function(doc) {
            this.$.map.path = doc.positions;
            this.$.map.showPath();
            this.state = SHOWING_TRACE;
          }.bind(this)).catch(function(e) {
            console.log(e);
          });
        },

        installApp: function() {
          this.$.drawerPanel.closeDrawer();
          var asPackage = false;
          var apps = navigator.mozApps;
          alert('installing');
          var installLocFind = asPackage ? apps.installPackage(this.packageManifestUrl) : apps.install(this.manifestUrl);
          installLocFind.onsuccess = function(data) {
            this.installable = false;
          }.bind(this);
          installLocFind.onerror = function() {
            alert(installLocFind.error.name);
          };
        },

        toggleRecording: function() {
          if (this.idle || this.showingTrace) {
            if (this.showingTrace) {
              this.$.map.path = null;
            }
            this.trace = new TR.Trace();
            this.$.location.watch = true;
            this.$.map.follow = true;
            this.state = RECORDING;
          } else if (this.recording) {
            this.$.location.watch = false;
            this.db.saveTrace(this.trace, Date.now() + '');
            this.trace = null;
            this.state = IDLE;
          }
        },

        showLocation: function() {
          this.$.map.follow = true;
          if (this.idle || this.showingTrace) {
            this.$.location.oneShot();
            if (this.showingTrace) {
              this.$.map.path = null;
            }
          }
        },

        showWaitingForLocationToast: function() {
          this.$.waitingForLocationToast.show();
        },

        toggleDrawer: function() {
          this.$.drawerPanel.togglePanel();
        },

        updateInstallButtonVisibility: function() {
          this.menuItems = this.menuItems;
          if ((location.protocol !== 'app:') && ('mozApps' in navigator)) {
            var request = navigator.mozApps.checkInstalled(this.manifestUrl)
            request.onsuccess = function(e) {
              if (!request.result) {
                this.installable = true;
              }
            }.bind(this);
            request.onerror = function(e) {
              alert(e);
            }.bind(this);
          }
        },

        onNewLocation: function(event) {
          var position = event.detail;
          this.$.map.marker = position;
          if (this.recording) {
            this.trace.appendPosition(position);
            this.$.map.path = this.trace.positions;
          }
        }
      });
    })();
  </script>
</polymer-element>

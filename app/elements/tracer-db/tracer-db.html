<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="tracer-db" attributes="">
  <script src="../../bower_components/pouchdb/dist/pouchdb.min.js"></script>
  <script src="../tracer.js"></script>
  <script>
    Polymer({
      publish: {
        /**
         * Fired when a synchronisation task completed successfully.
         * @event sync-complete
         */

        /**
         * Fired when a synchronisation task failed with an error.
         * @event sync-error
         */

        /**
         * Fired when the database is modified.
         * @event modified
         */
      },

      created: function() {
        this.db = new PouchDB('locations');
        this.remoteDb = new PouchDB('https://ttookedgaimplithenturedi:ywUb2kx3jnA40Yp6rou5Xyc5@arcs.cloudant.com/tracer', {
          ajax: {
            cache: true
          }
        });
      },

      sync: function() {
        PouchDB.sync(this.db, this.remoteDb, {
          live: false
        }).on('change', function(info) {
          console.log('PouchDB ' + (info.direction === 'pull' ? 'remote' : 'local') + ' modified');
          this.fire('modified');
        }.bind(this)).on('complete', function(info) {
          console.log('PouchDB sync is complete');
          this.fire('sync-complete');
        }.bind(this)).on('error', function(err) {
          console.log('PouchDB error while synchronising:');
          console.log(err);
          this.fire('sync-error', err);
        }.bind(this));
      },

      saveTrace: function(trace) {
        this.db.put(trace.toDb()).then(function() {
          this.fire('modified');
        }.bind(this)).catch(function(err) {
          console.log(err);
        });
      },

      deleteTrace: function(id) {
        this.db.remove(id).then(function() {
          this.fire('modified');
        }.bind(this)).catch(function(err) {
          console.log(err);
        });
      },

      listTraces: function() {
        return this.db.allDocs().then(function(doc) {
          return doc.rows.map(function(x) {
            return x.id;
          });
        });
      },

      loadTrace: function(id) {
        return this.db.get(id).then(function(x) {
          return new TR.Trace(x);
        });
      }
    });
  </script>
</polymer-element>

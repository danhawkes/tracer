<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="tracer-db">
  <script src="../../bower_components/pouchdb/dist/pouchdb.min.js"></script>
  <script src="../tracer.js"></script>
  <script>
    Polymer({
      publish: {
        account: null,
        dbId: null

        /**
         * Fired when a synchronisation task completed successfully.
         * @event sync-complete
         */

        /**
         * Fired when a synchronisation task failed with an error.
         * @event sync-error
         */

        /**
         * Fired when the database is modified.
         * @event modified
         */
      },

      created: function() {
        this.db = new PouchDB('locations');
      },

      accountChanged: function() {
        if (this.account !== null) {
          var observer = new PathObserver(this.account, 'dbId');
          observer.open(function(newValue, oldValue) {
            this.remoteDb = new
              PouchDB('http://' + this.account.username + ':' + this.account.password + '@178.62.29.239:5984/' +
            this.account.dbId, {
              ajax: {
                cache: true
              }
            });
          }.bind(this));
        } else {
          this.remoteDb = null;
        }
      },

      sync: function() {
        PouchDB.sync(this.db, this.remoteDb, {
          live: false
        }).on('change', function(info) {
          console.log('PouchDB ' + (info.direction === 'pull' ? 'remote' : 'local') + ' modified');
          this.fire('modified');
        }.bind(this)).on('complete', function(info) {
          console.log('PouchDB sync is complete');
          this.fire('sync-complete');
        }.bind(this)).on('error', function(err) {
          console.log('PouchDB error while synchronising:');
          console.log(err);
          this.fire('sync-error', err);
        }.bind(this));
      },

      saveTrace: function(trace) {
        this.db.put(trace.toDb()).then(function() {
          this.fire('modified');
        }.bind(this)).catch(function(err) {
          console.log(err);
        });
      },

      deleteTrace: function(id) {
        this.db.remove(id).then(function() {
          this.fire('modified');
        }.bind(this)).catch(function(err) {
          console.log(err);
        });
      },

      listTraces: function() {
        return this.db.allDocs().then(function(doc) {
          return doc.rows.map(function(x) {
            return x.id;
          });
        });
      },

      loadTrace: function(id) {
        return this.db.get(id).then(function(x) {
          return new TR.Trace(x);
        });
      }
    });
  </script>
</polymer-element>

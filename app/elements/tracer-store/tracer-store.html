<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="tracer-store">
  <script src="../../bower_components/pouchdb/dist/pouchdb.js"></script>
  <script src="../tracer.js"></script>
  <script>
    Polymer({
      publish: {
        user: null

        /**
         * Fired when a synchronisation task completed successfully.
         * @event sync-complete
         */

        /**
         * Fired when a synchronisation task failed with an error.
         * @event sync-error
         */

        /**
         * Fired when the database is modified.
         * @event modified
         */
      },

      created: function() {
        this.db = new PouchDB('local');
        this.db.get('user').then(function(doc) {
          this.user = doc;
        }.bind(this));
      },

      userChanged: function(oldValue, newValue) {
        if (this.user !== null) {
          this.db.put(this.user, 'user').catch(function(e) {
            console.log(e);
          });
          this.remoteDb = new
            PouchDB(this.user.dbUrl, {
            ajax: {
              cache: true
            }
          });
        } else {
          // Delete everything
          this.db.allDocs().then(function(docs) {
            var update = [];
            docs.rows.forEach(function(doc) {
              update.push({_id: doc.id, _rev: doc.value.rev, _deleted: true});
            });
            return this.db.bulkDocs(update);
          }.bind(this)).catch(function(e) {
            console.log(e);
          });
          this.remoteDb = null;
        }
      },

      sync: function() {
        PouchDB.sync(this.db, this.remoteDb, {
          live: false
        }).on('change', function(info) {
          console.log('PouchDB ' + (info.direction === 'pull' ? 'remote' : 'local') + ' modified');
          this.fire('modified');
        }.bind(this)).on('complete', function(info) {
          console.log('PouchDB sync is complete');
          this.fire('sync-complete');
        }.bind(this)).on('error', function(err) {
          console.log('PouchDB error while synchronising:');
          console.log(err);
          this.fire('sync-error', err);
        }.bind(this));
      },

      saveTrace: function(trace) {
        this.db.put(trace.toDb()).then(function() {
          this.fire('modified');
        }.bind(this)).catch(function(err) {
          console.log(err);
        });
      },

      deleteTrace: function(id) {
        this.db.remove(id).then(function() {
          this.fire('modified');
        }.bind(this)).catch(function(err) {
          console.log(err);
        });
      },

      listTraces: function() {
        return this.db.query('types/traces').then(function(doc) {
          return doc.rows.map(function(x) {
            return x.id;
          });
        });
      },

      loadTrace: function(id) {
        return this.db.get(id).then(function(doc) {
          return new TR.Trace(doc);
        });
      }
    });
  </script>
</polymer-element>

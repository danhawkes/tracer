<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/core-icon/core-icon.html">
<link rel="import" href="../../bower_components/core-selector/core-selector.html">
<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">

<polymer-element name="tracer-traceslistpage">

  <template>
    <link rel="stylesheet" href="tracer-traceslistpage.css">

    <div id="content" layout fit>
      <!--<core-animated-pages id="pages" fit selected="{{selectedPageIndex}}"-->
      <!--transitions="hero-transition cross-fade"-->
      <!--on-core-animated-pages-transition-end="{{onTransitionEnd}}">-->
      <!--<section fit>-->
      <div id="listPage" cross-fade fit layout vertical>
        <paper-shadow id="mapContainer" hero hero-id="map">
          <tracer-map id="map" path="{{trace.positions}}"
                      showPath="true"></tracer-map>
          <!--<paper-fab id="fab-info" icon="info-outline" hidden?="{{selected == -1}}"-->
          <!--on-tap="{{showTraceInfo}}"></paper-fab>-->
        </paper-shadow>
        <div class="panel" flex hero hero-id="content">
          <!--<core-selector flex selected="{{selected}}" selectedAttribute="">-->
            <template repeat="{{item in items}}">
              <paper-item>{{item.id | formatDate}}</paper-item>
            </template>
          <!--</core-selector>-->
        </div>
      </div>
      <!--</section>-->
      <!--<section>-->
      <!--<div id="infoPage" cross-fade fit on-click="{{back}}">-->
      <!--<paper-shadow id="infoMapContainer">-->
      <!--<tracer-map id="infoMap" hero hero-id="map" fit path="{{trace.positions}}"-->
      <!--showPath="true"></tracer-map>-->
      <!--</paper-shadow>-->
      <!--<div class="panel" flex hero hero-id="content">-->
      <!--<paper-item>Duration: {{trace | formatDuration}}</paper-item>-->
      <!--<paper-item>Elevation change: {{trace | formatElevationChange}}</paper-item>-->
      <!--<paper-item>Calories: 456</paper-item>-->
      <!--</div>-->
      <!--</div>-->
      <!--</section>-->
      <!--</core-animated-pages>-->
    </div>

  </template>

  <script>
    Polymer({
      publish: {
        db: null
      },

      created: function() {
        this.selected = 0;
      },

      dbChanged: function() {
        if (this.db) {
          this.updateList();
          this.db.addEventListener('modified', function(e) {
            this.updateList();
          }.bind(this));
        }
      },

      itemsChanged: function() {
        if (this.items && this.items.length > this.selected) {
          this.showTrace(this.items[this.selected].id);
        }
      },

      selectedChanged: function(oldVal, newVal) {
        this.showTrace(this.items[this.selected].id);
      },

      updateSize: function() {
        this.$.map.updateSize();
      },

      updateList: function() {
        this.db.listTraces().then(function(doc) {
          this.items = doc.rows;
        }.bind(this)).catch(function(err) {
          console.print('error while listing traces:');
          console.print(err);
        });
      },

      showTrace: function(traceId) {
        this.db.loadTrace(traceId).then(function(trace) {
          this.trace = trace;
          console.log('');
        }.bind(this)).catch(function(e) {
          console.log(e);
        });
      },

      formatDate: function(timestamp) {
        return new Date(Number(timestamp)).toLocaleString();
      },

      formatDuration: function(trace) {
        if (trace) {
          var d = new Date(trace.duration());
          var s = '';
          var hours = d.getHours;
          var mins = d.getMinutes();
          if (hours > 0) {
            s += hours + ' hours';
          }
          s += mins + ' mins';
          return s;
        } else {
          return '';
        }
      },

      formatElevationChange: function(trace) {
        if (trace) {
          return trace.elevationChange() + 'm';
        } else {
          return '';
        }
      },

      showTraceInfo: function() {
        this.selectedPageIndex = 1;
      },

      back: function() {
        this.selectedPageIndex = 0;
      },

      onTransitionEnd: function(a, b, c) {
        if (this.selectedPageIndex == 1) {
          this.$.infoMap.updateSize();
        }
      }
    });
  </script>
</polymer-element>

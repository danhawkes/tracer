<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-shadow/paper-shadow.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/core-icon/core-icon.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../../bower_components/core-selector/core-selector.html">
<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">

<polymer-element name="tracer-traceslistpage">

  <template>
    <link rel="stylesheet" href="tracer-traceslistpage.css">

    <div layout fit>
      <core-animated-pages id="pages" fit selected="{{selectedListPageIndex}}"
                           transitions="hero-transition cross-fade"
                           on-core-animated-pages-transition-end="{{onTransitionEnd}}">
        <section>
          <div id="listPage" cross-fade fit layout vertical>
            <paper-shadow id="listMapContainer" hero hero-id="map">
              <tracer-map id="map" fit path="{{trace.positions}}"
                          showPath="true">
                <paper-fab id="fab-info" icon="expand-more" hidden?="{{selected == -1}}"
                           on-tap="{{showTraceInfo}}"></paper-fab>
              </tracer-map>

            </paper-shadow>
            <paper-shadow id="listItems" flex cross-fade>
              <div fit>
                <core-selector selected="{{selected}}" selectedAttribute="">
                  <template repeat="{{item in items}}">
                    <paper-item>{{item | formatDate}}</paper-item>
                  </template>
                </core-selector>
              </div>
            </paper-shadow>
          </div>
        </section>

        <section>
          <div id="infoPage" fit hero hero-id="map">
            <core-animated-pages id="infoPages" fit selected="{{selectedInfoPageIndex}}" transitions="cross-fade">
              <section>
                <tracer-map id="infoMap" cross-fade fit path="{{trace.positions}}" showPath="true"></tracer-map>
              </section>
              <section>
                <paper-shadow id="metricsCard" cross-fade>
                  <paper-item>Duration: {{trace | formatDuration}}</paper-item>
                  <paper-item>Elevation change: {{trace | formatElevationChange}}</paper-item>
                  <paper-item>Calories: 456 kcal</paper-item>
                </paper-shadow>
              </section>
            </core-animated-pages>
            <core-toolbar id="infoToolbar" cross-fade fit layout>
              <paper-icon-button icon="arrow-back" on-tap="{{back}}"></paper-icon-button>
              <paper-tabs id="infoTabs" selected="{{selectedInfoPageIndex}}" flex>
                <paper-tab>MAP</paper-tab>
                <paper-tab>STATS</paper-tab>
              </paper-tabs>
            </core-toolbar>
          </div>
        </section>
      </core-animated-pages>
    </div>

  </template>

  <script>
    Polymer({
      publish: {
        db: null
      },

      created: function() {
        this.selected = 0;
      },

      dbChanged: function() {
        if (this.db) {
          this.updateList();
          this.db.addEventListener('modified', function(e) {
            this.updateList();
          }.bind(this));
        }
      },

      itemsChanged: function() {
        if (this.items && this.items.length > this.selected) {
          this.showTrace(this.items[this.selected]);
        }
      },

      selectedChanged: function(oldVal, newVal) {
        this.showTrace(this.items[this.selected]);
      },

      updateSize: function() {
        this.$.map.updateSize();
      },

      updateList: function() {
        this.db.listTraces().then(function(items) {
          this.items = items;
        }.bind(this)).catch(function(err) {
          console.print('error while listing traces:');
          console.print(err);
        });
      },

      showTrace: function(traceId) {
        this.db.loadTrace(traceId).then(function(trace) {
          this.trace = trace;
        }.bind(this)).catch(function(e) {
          console.log(e);
        });
      },

      formatDate: function(timestamp) {
        return new Date(Number(timestamp)).toLocaleString();
      },

      formatDuration: function(trace) {
        if (trace) {
          var d = new Date(trace.duration());
          var s = '';
          var hours = d.getHours;
          var mins = d.getMinutes();
          if (hours > 0) {
            s += hours + ' hours';
          }
          s += mins + ' mins';
          return s;
        } else {
          return '';
        }
      },

      formatElevationChange: function(trace) {
        if (trace) {
          return trace.elevationChange().toFixed(1) + 'm';
        } else {
          return '';
        }
      },

      showTraceInfo: function() {
        this.selectedListPageIndex = 1;
      },

      back: function() {
        this.selectedListPageIndex = 0;
      },

      onTransitionEnd: function() {
        if (this.selectedListPageIndex == 1) {
          this.$.infoMap.updateSize();
        }
      }
    });
  </script>
</polymer-element>
